__        __              _                    
\ \      / /_ _ _____   _| |__                 
 \ \ /\ / / _` |_  / | | | '_ \                
  \ V  V / (_| |/ /| |_| | | | |               
 __\_/\_/ \__,_/___|\__,_|_| |_|_              
|_   _|__| | ___ _ __ ___   ___| |_ _ __ _   _ 
  | |/ _ \ |/ _ \ '_ ` _ \ / _ \ __| '__| | | |
  | |  __/ |  __/ | | | | |  __/ |_| |  | |_| |
  |_|\___|_|\___|_| |_| |_|\___|\__|_|   \__, |
                                         |___/ 


**OBJECTIVE**
Genetrate Telemetry & Ingest into Wazuh 

The primary purpose is to generate telemetry from our devices [windows 10, windows sever 2k8r] to monitor and analyze it from Wazuh
if you don't know what telemetry is you can read [this article](https://www.splunk.com/en_us/blog/learn/what-is-telemetry.html) from splunk that explains it.

**NOTE MAKE A COPY OF THE OSSEC.CONF FILE**

1. Edit the configuration file for wazuh on windows machine (or your device)
    - Open the ossec.conf file, this file is created when you install wazuh-agent on the device. 
        - File explores --> This PC --> (select the drive where you installed wazuh agent e.g, C:\ ) --> Program FIles (x86) --> ossec-agent --> ossec.conf <----- NOTE that you might need admin privilages to edit the file
    - Look  for the "Log analysis" within the file copy and paste the "localfile" tag and add the applications you want to send the log from
        - Example using syslog: 
            - Event Viewer --> Applications and Services --> Microsoft --> Windows --> Sysmon --> Right click 'Operstional' --> Properties --> copy 'Full Name' --> Paste the fill name in the 'Application' [localfile tag](../assets/localfile%20tag.png) 
    - Restart the Wazuh service:
        - Services --> Wazuh --> Right click --> Restart 
        - This will generate archive files that wazuh will save all the events to, we need to configure filebeats to send this archive to wazuh. you can check the archive file at [/var/ossec/logs/archives/](../assets/archive-logs-files.png)

2. Configure the filebeat file to forward the archive logs to wazuh
    - Open the filebeat.yml file 
        - nano /etc/filebeat/filebeat.yml
     - Look for the 'archives' option under 'filebeat.modules' section
        - Change the 'enable' option from 'false' to 'ture' [check](../assets/archives-options.png)
    - Restart filebeat.service

3. Create a new index in wazuh dashboard 
    - Login to wazuh dashboard --> Click on Menu --> Management --> Stack Management --> Index Patterns --> Create index pattern 
    - For name name it your prefered name (e.g, wazuh-archives-*)
    - For 'Time Field' seclect 'Timestamp' and click create index pattern
    - Click menu --> Discover --> Click 'wazuh-alerts-* ' and change it to index you created (e.g, wazuh-archives-*)

4. Generate events with mimikatz to see if wazuh picks up the alerts, first we need to download mimikatz and run it in our machine using a powershell window, mimikatz is an open-source application that its primary use is for ectracting sensitive information, such as passwords, password hashes, PINs, and kerberos tickets form the memory of windows operating systems, you can [learn more here](https://www.sentinelone.com/cybersecurity-101/threat-intelligence/mimikatz/)

    - We need to create an excusion to download mimikatzm if you dont do this windows might block the download
        - Windows Security --> Virus & Threat Protection --> Manage Settings --> Exclusions --> Add or Remove Exclusion --> Add an exclusion --> Select your desired folder and click add. [check](../assets/mimikatz-folder-exlusion.png)
    - Download mimikats from [here](https://github.com/gentilkiwi/mimikatz/releases) and save the file to the folder you excluded (NOTE: your browser might block the downoad)
    - Extract the conetent of mimikatz open a new powershell window with admin priviages 
        - Poowershell --> cd to mimikatz folder --> and run ./x64/mimikatz.exe [check](../assets/powershell-mimikatz.png)
    - Go back to Wazuh dashboard and check your archives index, look for mimikatz event [check](../assets/mimikatz-event-wazuh-dashboard.png)
    - Alternatevly you can check you wazuh terminal or windows event viewer for events
        - cat /var/ossec/logs/archives/archives.json | grep -i mimikatz you should see something like [this](../assets/wazuh-terminal-mimikatz.png) 
        - - Event Viewer --> Applications and Services --> Microsoft --> Windows --> Sysmon --> Click on 'operationals' --> filter current log --> give it the id of '1' (process creation) and look for 'originFile:mimikatz' [check](../assets/mimikatz-event-viewer.png)


NOTE by default wazuh does not forward all the alert, you need to configure it if you want to log all the alerts generated by the device.
**OPTIONAL**
1. Configure Wazuh agent to log everything on the device and send it to wazuh
    - On your Wazuh Machine make a copy of the ossec.conf file
        - cp /var/ossec/etc/ossec.conf ./ossec-backup.conf <-- Example
    - Open the ossec.conf file, and look for the 'logall' option under 'ossec_config' section, change it from 'no' to 'yes' to the same with 'logall_json' option (optional) [check](../assets/logall-configuration%20wazuh.png)
    - Save the file and restart the sevice
        - systemctl restart wazuh-manager.service
2. Login to the wazuh dashboard --> Security Events --> In the search bar type "sysmon" --> you should see sysmon event from windows machien 
**NOTE if you dont see sysmon events right aways its normal**

**If you want to forward more log from different appications you can add more 'localfile' tags and follow the same steps**

